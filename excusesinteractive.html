<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Making Explanations: Interactive Self-Study Guide</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }

        header {
            background: #2c3e50;
            color: white;
            padding: 1rem;
            text-align: center;
        }

        h1 {
            font-size: 1.8rem;
            margin-bottom: 0.5rem;
        }

        .progress-container {
            background: rgba(255,255,255,0.2);
            border-radius: 10px;
            padding: 5px;
            margin-top: 1rem;
        }

        .progress-bar {
            background: #27ae60;
            height: 8px;
            border-radius: 5px;
            width: 0%;
            transition: width 0.3s ease;
        }

        .task-counter {
            margin-top: 0.5rem;
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .navigation {
            background: #34495e;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .nav-buttons {
            display: flex;
            gap: 0.5rem;
        }

        .task-numbers {
            display: flex;
            gap: 0.3rem;
            flex-wrap: wrap;
        }

        .task-num {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 0.3rem 0.6rem;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.8rem;
        }

        .task-num:hover {
            background: rgba(255,255,255,0.3);
        }

        .task-num.active {
            background: #27ae60;
        }

        .task-num.completed {
            background: #2ecc71;
        }

        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 0.6rem 1.2rem;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        button:hover {
            background: #2980b9;
            transform: translateY(-1px);
        }

        button:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
        }

        .check-btn {
            background: #27ae60;
        }

        .check-btn:hover {
            background: #229954;
        }

        .reset-btn {
            background: #e74c3c;
        }

        .reset-btn:hover {
            background: #c0392b;
        }

        main {
            padding: 2rem;
            min-height: 60vh;
        }

        .task {
            display: none;
        }

        .task.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .task-header {
            background: #ecf0f1;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            border-left: 4px solid #3498db;
        }

        .task-title {
            font-size: 1.4rem;
            color: #2c3e50;
            margin-bottom: 0.5rem;
        }

        .task-instructions {
            color: #7f8c8d;
            font-style: italic;
        }

        /* Task 1 specific styles */
        .task1-layout {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .story-text {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 8px;
            line-height: 1.8;
            border: 2px solid #e9ecef;
        }

        .story-text h3 {
            color: #2c3e50;
            margin-bottom: 1rem;
        }

        .clickable-phrase {
            background: #fff3cd;
            padding: 2px 4px;
            border-radius: 3px;
            cursor: pointer;
            border: 1px solid #ffeaa7;
            transition: all 0.3s ease;
        }

        .clickable-phrase:hover {
            background: #ffd93d;
        }

        .clickable-phrase.selected {
            background: #007bff;
            border-color: #0056b3;
            color: white;
        }

        .clickable-phrase.found {
            background: #d4edda;
            border-color: #27ae60;
            color: #155724;
        }

        .category-btn:hover {
            opacity: 0.8;
        }

        .category-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* New CSS classes to replace inline styles */
        .category-btn {
            color: white;
            margin: 0.2rem;
            padding: 0.5rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .category-btn[data-category="explanation"] {
            background: #3498db;
        }
        
        .category-btn[data-category="regret"] {
            background: #e74c3c;
        }
        
        .category-btn[data-category="problem"] {
            background: #f39c12;
        }
        
        .category-btn[data-category="idiom"] {
            background: #9b59b6;
        }
        
        .category-buttons {
            margin-bottom: 1rem;
        }
        
        .selected-phrase {
            background: #fff3cd;
            padding: 0.5rem;
            border-radius: 4px;
            margin-bottom: 1rem;
            font-weight: bold;
            min-height: 20px;
            border: 2px dashed #ffc107;
        }
        
        .dialogue-container {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 5px;
            margin: 1rem 0;
        }
        
        .dialogue-select {
            padding: 0.3rem;
            border: 1px solid #dee2e6;
            border-radius: 3px;
        }
        
        .rewrite-input {
            min-width: 200px;
        }

        .task1-sidebar {
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 1.5rem;
            height: fit-content;
        }

        .phrase-categories {
            margin-bottom: 1.5rem;
        }

        .phrase-categories h4 {
            color: #495057;
            margin-bottom: 0.8rem;
            font-size: 1rem;
        }

        .phrase-list {
            background: #f8f9fa;
            border-radius: 5px;
            padding: 0.8rem;
            margin-bottom: 1rem;
            min-height: 60px;
        }

        .found-phrase {
            background: #d4edda;
            color: #155724;
            padding: 0.3rem 0.6rem;
            border-radius: 4px;
            margin: 0.2rem;
            display: inline-block;
            font-size: 0.8rem;
            border: 1px solid #c3e6cb;
        }

        /* Regular task styles */
        .question {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .question h4 {
            color: #2c3e50;
            margin-bottom: 1rem;
        }

        .options {
            display: grid;
            gap: 0.8rem;
            margin-top: 1rem;
        }

        .option {
            display: flex;
            align-items: center;
            padding: 0.8rem;
            background: #f8f9fa;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .option:hover {
            background: #e9ecef;
        }

        .option input {
            margin-right: 0.8rem;
        }

        .option.selected {
            border-color: #3498db;
            background: #ebf3fd;
        }

        .option.correct {
            border-color: #27ae60;
            background: #d4edda;
        }

        .option.incorrect {
            border-color: #e74c3c;
            background: #f8d7da;
        }

        .fill-blank {
            display: inline-block;
            min-width: 100px;
            padding: 0.3rem 0.6rem;
            border: 2px solid #dee2e6;
            border-radius: 4px;
            margin: 0 0.3rem;
        }

        .task-controls {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 2px solid #e9ecef;
        }

        .feedback {
            margin-top: 1.5rem;
            padding: 1rem;
            border-radius: 8px;
            display: none;
        }

        .feedback.success {
            background: #d4edda;
            border: 2px solid #c3e6cb;
            color: #155724;
        }

        .feedback.error {
            background: #f8d7da;
            border: 2px solid #f5c6cb;
            color: #721c24;
        }

        .feedback.show {
            display: block;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .explanation {
            margin-top: 0.8rem;
            font-weight: 500;
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .task1-layout {
                grid-template-columns: 1fr;
            }
            
            .navigation {
                flex-direction: column;
                align-items: stretch;
            }
            
            .nav-buttons {
                justify-content: space-between;
            }
            
            .task-numbers {
                justify-content: center;
            }
            
            main {
                padding: 1rem;
            }
        }

        /* Vocabulary categorization table */
        .vocab-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .vocab-table th, .vocab-table td {
            border: 2px solid #dee2e6;
            padding: 0.8rem;
            text-align: left;
        }

        .vocab-table th {
            background: #f8f9fa;
            color: #495057;
            font-weight: 600;
        }

        .vocab-table td {
            background: white;
        }

        /* Glossary Styles */
        .glossary-term {
            border-bottom: 2px dotted #3498db;
            cursor: pointer;
            position: relative;
        }

        .glossary-tooltip {
            position: absolute;
            background-color: #2c3e50;
            color: white;
            padding: 8px 12px;
            border-radius: 5px;
            z-index: 100;
            bottom: 125%; /* Position above the term */
            left: 50%;
            transform: translateX(-50%);
            white-space: nowrap;
            font-size: 0.9rem;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .glossary-tooltip::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #2c3e50 transparent transparent transparent;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>📚 Making Explanations: Interactive Self-Study Guide</h1>
            <p>Pre-Intermediate to Intermediate Level</p>
            <div class="progress-container">
                <div class="progress-bar" id="progressBar"></div>
            </div>
            <div class="task-counter">
                Task <span id="currentTask">1</span> of <span id="totalTasks">7</span>
            </div>
        </header>

        <nav class="navigation">
            <div class="nav-buttons">
                <button id="prevBtn" onclick="previousTask()">← Previous</button>
                <button id="nextBtn" onclick="nextTask()">Next →</button>
            </div>
            <div class="task-numbers" id="taskNumbers">
                <!-- Task numbers will be populated by JavaScript -->
            </div>
        </nav>

        <main>
            <!-- Task 1: Language Discovery -->
            <div class="task active" id="task1">
                <div class="task-header">
                    <h2 class="task-title">🔍 Task 1: Language Discovery & Vocabulary</h2>
                    <p class="task-instructions">
                        <strong>Instructions:</strong> Read Emma's story. Click on highlighted phrases to categorize them. Click on dotted-underlined words to see their Polish translation.
                    </p>
                </div>

                <div class="task1-layout">
                    <div class="story-text">
                        <h3>📖 Emma's Worst Day Ever</h3>
                        <p>Emma woke up late on Monday morning because her phone had died overnight and her alarm didn't go off. <span class="clickable-phrase" data-category="explanation" data-phrase="The thing is">"The thing is,"</span> she texted her manager, "my charger broke and I didn't realize my phone was dead until this morning. <span class="clickable-phrase" data-category="regret" data-phrase="I feel terrible about">I feel terrible about</span> being late!"</p>

                        <p><span class="clickable-phrase" data-category="explanation" data-phrase="What happened was">What happened was</span> even worse. Emma <span class="glossary-term" data-translation="pędziła, spieszyła się">rushed</span> to catch the bus, but slipped on the wet pavement and landed in <span class="glossary-term" data-translation="kałuża">a puddle</span>. Her white shirt was completely <span class="glossary-term" data-translation="przemoczona">soaked</span> and <span class="glossary-term" data-translation="zabłocona">muddy</span>. <span class="clickable-phrase" data-category="explanation" data-phrase="You see">"You see,"</span> she explained to her colleague later, "I was running so fast that I didn't notice the water on the ground. <span class="clickable-phrase" data-category="explanation" data-phrase="Due to">Due to</span> the rain last night, the sidewalk was <span class="clickable-phrase" data-category="idiom" data-phrase="like an ice rink">like an <span class="glossary-term" data-translation="lodowisko">ice rink</span></span>!"</p>

                        <p>At lunch, Emma had planned to meet her best friend Sarah at their favorite café. However, she got completely lost because she was using an old map app. <span class="clickable-phrase" data-category="regret" data-phrase="I'm so embarrassed">"I'm so embarrassed!"</span> Emma called Sarah <span class="glossary-term" data-translation="gorączkowo, panicznie">frantically</span>. <span class="clickable-phrase" data-category="explanation" data-phrase="What happened was">"What happened was</span> my GPS app crashed, and I've been walking in circles for 30 minutes. <span class="clickable-phrase" data-category="explanation" data-phrase="The problem was">The problem was</span> I was too proud to ask for directions!"</p>

                        <p>The afternoon brought more <span class="clickable-phrase" data-category="problem" data-phrase="disasters"><span class="glossary-term" data-translation="katastrofy">disasters</span></span>. Emma was supposed to submit an important report by 4 PM, but her computer <span class="clickable-phrase" data-category="problem" data-phrase="crashed">crashed</span> just as she was finishing it. <span class="clickable-phrase" data-category="regret" data-phrase="I hate to say this">"I hate to say this,"</span> she emailed her boss, "but I lost three hours of work. The reason is our office computer system had a major <span class="clickable-phrase" data-category="problem" data-phrase="glitch"><span class="glossary-term" data-translation="usterka, zakłócenie">glitch</span></span>. I tried everything to recover the file, but it was no use."</p>

                        <p>On her way home, Emma's train was <span class="clickable-phrase" data-category="problem" data-phrase="delayed">delayed</span> for two hours due to signal problems. She was supposed to have dinner with her parents, but arrived just as they were finishing dessert. <span class="clickable-phrase" data-category="regret" data-phrase="I feel so bad about">"I feel so bad about</span> missing dinner!" she apologized. "The <span class="glossary-term" data-translation="okoliczności">circumstances</span> were completely beyond my control. First, there was a signal <span class="clickable-phrase" data-category="problem" data-phrase="failure"><span class="glossary-term" data-translation="awaria">failure</span></span>, then they had to wait for an engineer, and finally we were stuck between stations for an hour."</p>

                        <p>Emma's mother just laughed. "Don't worry, dear. <span class="clickable-phrase" data-category="idiom" data-phrase="Better late than never">Better late than never</span>! We saved you some food. Besides, <span class="clickable-phrase" data-category="idiom" data-phrase="no harm done"><span class="glossary-term" data-translation="nic się nie stało">no harm done</span></span> – these things happen to everyone."</p>

                        <p>By the time Emma got to bed, she was exhausted. "Tomorrow has to be better," she thought. "I mean, what are the chances of having such a terrible day twice in a row?" Little did she know, her alarm was already set for the wrong time...</p>
                    </div>

                    <div class="task1-sidebar">
                        <div class="phrase-categories">
                            <div class="category-buttons">
                                <button class="category-btn" data-category="explanation" role="button" tabindex="0" aria-label="Categorize as explanation starter">📝 Explanation Starters</button>
                                <button class="category-btn" data-category="regret" role="button" tabindex="0" aria-label="Categorize as regret expression">😔 Regret/Apology</button>
                                <button class="category-btn" data-category="problem" role="button" tabindex="0" aria-label="Categorize as problem word">⚠️ Problems</button>
                                <button class="category-btn" data-category="idiom" role="button" tabindex="0" aria-label="Categorize as idiom">🎭 Idioms</button>
                            </div>
                            
                            <div id="selected-phrase" class="selected-phrase" aria-live="polite">
                                <em>Select a phrase from the text above...</em>
                            </div>

                            <h4>📝 Explanation Starters:</h4>
                            <div class="phrase-list" id="explanation-phrases">
                                <em>Click phrases, then category buttons...</em>
                            </div>

                            <h4>😔 Regret/Apology Expressions:</h4>
                            <div class="phrase-list" id="regret-phrases">
                                <em>Click phrases, then category buttons...</em>
                            </div>

                            <h4>⚠️ Problem/Difficulty Words:</h4>
                            <div class="phrase-list" id="problem-phrases">
                                <em>Click phrases, then category buttons...</em>
                            </div>

                            <h4>🎭 Idioms:</h4>
                            <div class="phrase-list" id="idiom-phrases">
                                <em>Click phrases, then category buttons...</em>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="task-controls">
                    <button class="check-btn" onclick="checkTask1()">Check Answers</button>
                    <button class="reset-btn" onclick="resetTask1()">Reset</button>
                </div>

                <div class="feedback" id="task1-feedback"></div>
            </div>

            <!-- Task 2: True/False -->
            <div class="task" id="task2">
                <div class="task-header">
                    <h2 class="task-title">✅ Task 2: Tricky True or False</h2>
                    <p class="task-instructions">
                        <strong>Instructions:</strong> Read each statement carefully and decide if it's true or false. 
                        Some statements are tricky - pay attention to the details!
                    </p>
                </div>

                <div class="question">
                    <h4>1. Emma's phone alarm didn't work because she forgot to set it.</h4>
                    <div class="options">
                        <div class="option" onclick="selectOption(this, 'task2', 1)">
                            <input type="radio" name="q1"> True
                        </div>
                        <div class="option" onclick="selectOption(this, 'task2', 1)">
                            <input type="radio" name="q1"> False
                        </div>
                    </div>
                </div>

                <div class="question">
                    <h4>2. Emma slipped because she was running too fast and didn't see the water.</h4>
                    <div class="options">
                        <div class="option" onclick="selectOption(this, 'task2', 2)">
                            <input type="radio" name="q2"> True
                        </div>
                        <div class="option" onclick="selectOption(this, 'task2', 2)">
                            <input type="radio" name="q2"> False
                        </div>
                    </div>
                </div>

                <div class="question">
                    <h4>3. Emma's computer crashed before she could finish her report.</h4>
                    <div class="options">
                        <div class="option" onclick="selectOption(this, 'task2', 3)">
                            <input type="radio" name="q3"> True
                        </div>
                        <div class="option" onclick="selectOption(this, 'task2', 3)">
                            <input type="radio" name="q3"> False
                        </div>
                    </div>
                </div>

                <div class="question">
                    <h4>4. The train delay was Emma's fault.</h4>
                    <div class="options">
                        <div class="option" onclick="selectOption(this, 'task2', 4)">
                            <input type="radio" name="q4"> True
                        </div>
                        <div class="option" onclick="selectOption(this, 'task2', 4)">
                            <input type="radio" name="q4"> False
                        </div>
                    </div>
                </div>

                <div class="question">
                    <h4>5. Emma's parents were upset that she missed dinner.</h4>
                    <div class="options">
                        <div class="option" onclick="selectOption(this, 'task2', 5)">
                            <input type="radio" name="q5"> True
                        </div>
                        <div class="option" onclick="selectOption(this, 'task2', 5)">
                            <input type="radio" name="q5"> False
                        </div>
                    </div>
                </div>

                <div class="question">
                    <h4>6. Emma gave different types of explanations to different people.</h4>
                    <div class="options">
                        <div class="option" onclick="selectOption(this, 'task2', 6)">
                            <input type="radio" name="q6"> True
                        </div>
                        <div class="option" onclick="selectOption(this, 'task2', 6)">
                            <input type="radio" name="q6"> False
                        </div>
                    </div>
                </div>
                
                <div class="task-controls">
                    <button class="check-btn" onclick="checkTask2()">Check Answers</button>
                    <button class="reset-btn" onclick="resetTask2()">Reset</button>
                </div>

                <div class="feedback" id="task2-feedback"></div>
            </div>

            <!-- Task 3: Pattern Analysis -->
            <div class="task" id="task3">
                <div class="task-header">
                    <h2 class="task-title">🧩 Task 3: Pattern Analysis</h2>
                    <p class="task-instructions">
                        <strong>Instructions:</strong> Complete the explanation patterns using words from the story.
                    </p>
                </div>

                <div class="question">
                    <h4>Complete the explanation patterns:</h4>
                    <p><strong>Word bank:</strong> <em>happened, reason, to, see, problem</em></p>
                    <p>1. Due <input type="text" class="fill-blank" id="pattern1"> ...</p>
                    <p>2. You <input type="text" class="fill-blank" id="pattern2">, ...</p>
                    <p>3. What <input type="text" class="fill-blank" id="pattern3"> was...</p>
                    <p>4. The <input type="text" class="fill-blank" id="pattern4"> was...</p>
                    <p>5. The <input type="text" class="fill-blank" id="pattern5"> is...</p>
                </div>

                <div class="task-controls">
                    <button class="check-btn" onclick="checkTask3()">Check Answers</button>
                    <button class="reset-btn" onclick="resetTask3()">Reset</button>
                </div>

                <div class="feedback" id="task3-feedback"></div>
            </div>

            <!-- Task 4: Grammar Focus -->
            <div class="task" id="task4">
                <div class="task-header">
                    <h2 class="task-title">📚 Task 4: Grammar Focus - Causal Language</h2>
                    <p class="task-instructions">
                        <strong>Instructions:</strong> Complete the grammar rules and rewrite sentences using different causal expressions.
                    </p>
                </div>

                <div class="question">
                    <h4>A. Complete the grammar rules:</h4>
                    <p><strong>Word bank:</strong> <em>subject + verb, noun phrase</em></p>
                    <p>1. Because of + <input type="text" class="fill-blank" id="grammar1"></p>
                    <p>2. Due to + <input type="text" class="fill-blank" id="grammar2"></p>
                    <p>3. As a result of + <input type="text" class="fill-blank" id="grammar3"></p>
                    <p>4. Since + <input type="text" class="fill-blank" id="grammar4"></p>
                </div>

                <div class="question">
                    <h4>B. Rewrite these sentences using the causal expression in brackets.</h4>
                    
                    <p><strong>1.</strong> The sidewalk was slippery because it was raining. <br>→ (Use "Due to") The sidewalk was slippery due to <input type="text" class="fill-blank rewrite-input" id="rewrite1">.</p>
                    
                    <p><strong>2.</strong> The report was lost because the computer crashed. <br>→ (Use "As a result of") The report was lost as a result of <input type="text" class="fill-blank rewrite-input" id="rewrite2">.</p>
                    
                    <p><strong>3.</strong> Emma missed dinner because the train was delayed. <br>→ (Use "Because of") Emma missed dinner because of <input type="text" class="fill-blank rewrite-input" id="rewrite3">.</p>

                    <p><strong>4.</strong> Her alarm didn't work because her phone was dead. <br>→ (Use "Since") <input type="text" class="fill-blank rewrite-input" id="rewrite4">, her alarm didn't work.</p>
                </div>

                <div class="task-controls">
                    <button class="check-btn" onclick="checkTask4()">Check Answers</button>
                    <button class="reset-btn" onclick="resetTask4()">Reset</button>
                </div>

                <div class="feedback" id="task4-feedback"></div>
            </div>

            <!-- Task 5: Expression Practice -->
            <div class="task" id="task5">
                <div class="task-header">
                    <h2 class="task-title">💬 Task 5: Expression Practice</h2>
                    <p class="task-instructions">
                        <strong>Instructions:</strong> Choose the best expressions for each situation, then practice speaking your own explanations.
                    </p>
                </div>

                <div class="question">
                    <h4>A. Complete the dialogues by choosing the best expression:</h4>
                    
                    <div class="dialogue-container">
                        <p><strong>1. Situation:</strong> You're 30 minutes late for a study session.</p>
                        <p><strong>You say:</strong> 
                            <select id="dialogue1" class="dialogue-select">
                                <option value="">Choose...</option>
                                <option value="due-to">Due to</option>
                                <option value="what-happened">What happened was</option>
                                <option value="you-see">You see</option>
                            </select>
                            , I got on the wrong bus and ended up across town!"
                        </p>
                    </div>
                    
                    <div class="dialogue-container">
                        <p><strong>2. Situation:</strong> You forgot to bring the book you promised to return.</p>
                        <p><strong>You say:</strong> 
                            <select id="dialogue2a" class="dialogue-select">
                                <option value="">Choose...</option>
                                <option value="hate-to-say">I hate to say</option>
                                <option value="feel-terrible">I feel terrible</option>
                                <option value="problem-was">The problem was</option>
                            </select>
                            , I left it at home. 
                            <select id="dialogue2b" class="dialogue-select">
                                <option value="">Choose...</option>
                                <option value="you-see">You see</option>
                                <option value="thing-is">The thing is</option>
                                <option value="due-to">Due to</option>
                            </select>
                            I was rushing this morning."
                        </p>
                    </div>
                    
                    <div class="dialogue-container">
                        <p><strong>3. Situation:</strong> Your presentation file won't open in class.</p>
                        <p><strong>You say:</strong> 
                            <select id="dialogue3" class="dialogue-select">
                                <option value="">Choose...</option>
                                <option value="what-happened">What happened was</option>
                                <option value="embarrassed">I'm so embarrassed</option>
                                <option value="due-to">Due to</option>
                            </select>
                            , my computer crashed last night and corrupted the file!"
                        </p>
                    </div>
                </div>

                <div class="question">
                    <h4>B. Speaking Practice</h4>
                    <p>Read the scenarios below. Use the starter phrases to create a spoken explanation for each one. <strong>There is nothing to type here.</strong> Practice speaking out loud!</p>
                    
                    <div style="background: #f0f4f8; border-left: 4px solid #9b59b6; padding: 1rem; margin: 1rem 0; border-radius: 5px;">
                        <p><strong>Useful Starter Phrases:</strong></p>
                        <ul style="list-style-position: inside; columns: 2;">
                            <li>The thing is...</li>
                            <li>What happened was...</li>
                            <li>You see...</li>
                            <li>Due to...</li>
                            <li>The problem was...</li>
                            <li>The reason is...</li>
                            <li>I feel terrible about...</li>
                            <li>I'm so embarrassed...</li>
                        </ul>
                    </div>

                    <ol style="padding-left: 20px;">
                        <li style="margin-bottom: 0.5rem;"><strong>You are 15 minutes late for a doctor's appointment.</strong></li>
                        <li style="margin-bottom: 0.5rem;"><strong>You forgot to do your homework for class.</strong></li>
                        <li style="margin-bottom: 0.5rem;"><strong>You accidentally broke your friend's favorite coffee mug.</strong></li>
                        <li style="margin-bottom: 0.5rem;"><strong>You missed an important online meeting with your team.</strong></li>
                    </ol>
                </div>

                <div class="task-controls">
                    <button class="check-btn" onclick="checkTask5()">Check Part A</button>
                    <button class="reset-btn" onclick="resetTask5()">Reset Part A</button>
                </div>

                <div class="feedback" id="task5-feedback"></div>
            </div>

            <!-- Task 6: Idiom Exploration -->
            <div class="task" id="task6">
                <div class="task-header">
                    <h2 class="task-title">🎭 Task 6: Idiom Exploration</h2>
                    <p class="task-instructions">
                        <strong>Instructions:</strong> Match idioms with their meanings and complete sentences with the correct idioms.
                    </p>
                </div>

                <div class="question">
                    <h4>A. Match the idioms with their meanings:</h4>
                    <table class="vocab-table">
                        <tr>
                            <th>Idiom</th>
                            <th>Meaning</th>
                        </tr>
                        <tr>
                            <td>1. Better late than never</td>
                            <td>
                                <select id="idiom1">
                                    <option value="">Choose meaning...</option>
                                    <option value="a">Something from the past that's forgiven</option>
                                    <option value="b">Something good eventually, even if late</option>
                                    <option value="c">In trouble or difficulty</option>
                                    <option value="d">It's okay, no damage done</option>
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <td>2. Water under the bridge</td>
                            <td>
                                <select id="idiom2">
                                    <option value="">Choose meaning...</option>
                                    <option value="a">Something from the past that's forgiven</option>
                                    <option value="b">Something good eventually, even if late</option>
                                    <option value="c">In trouble or difficulty</option>
                                    <option value="d">It's okay, no damage done</option>
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <td>3. In hot water</td>
                            <td>
                                <select id="idiom3">
                                    <option value="">Choose meaning...</option>
                                    <option value="a">Something from the past that's forgiven</option>
                                    <option value="b">Something good eventually, even if late</option>
                                    <option value="c">In trouble or difficulty</option>
                                    <option value="d">It's okay, no damage done</option>
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <td>4. No harm done</td>
                            <td>
                                <select id="idiom4">
                                    <option value="">Choose meaning...</option>
                                    <option value="a">Something from the past that's forgiven</option>
                                    <option value="b">Something good eventually, even if late</option>
                                    <option value="c">In trouble or difficulty</option>
                                    <option value="d">It's okay, no damage done</option>
                                </select>
                            </td>
                        </tr>
                    </table>
                </div>

                <div class="question">
                    <h4>B. Complete these sentences with the correct idioms:</h4>
                    
                    <p>1. After missing the report deadline, John was really 
                        <select id="context1">
                            <option value="">Choose idiom...</option>
                            <option value="in-hot-water">in hot water</option>
                            <option value="no-harm-done">no harm done</option>
                            <option value="better-late">better late than never</option>
                        </select>
                        with his boss.
                    </p>
                                        
                    <p>2. Emma's mother said " 
                        <select id="context2">
                            <option value="">Choose idiom...</option>
                            <option value="no-harm-done">No harm done</option>
                            <option value="better-late">Better late than never</option>
                            <option value="in-hot-water">In hot water</option>
                        </select>
                        – we're just happy you're safe!"
                    </p>
                    
                    <p>3. The argument about being late is 
                        <select id="context3">
                            <option value="">Choose idiom...</option>
                            <option value="water-bridge">water under the bridge</option>
                            <option value="no-harm-done">no harm done</option>
                            <option value="better-late">better late than never</option>
                        </select>
                        now; let's move on.
                    </p>
                </div>

                <div class="task-controls">
                    <button class="check-btn" onclick="checkTask6()">Check Answers</button>
                    <button class="reset-btn" onclick="resetTask6()">Reset</button>
                </div>

                <div class="feedback" id="task6-feedback"></div>
            </div>

            <!-- Task 7: Idiom Application -->
            <div class="task" id="task7">
                <div class="task-header">
                    <h2 class="task-title">🎯 Task 7: Idiom Application</h2>
                    <p class="task-instructions">
                        <strong>Instructions:</strong> Choose the idiom that best describes each situation.
                    </p>
                </div>

                <div class="question">
                    <h4>A. Choose the idiom that best describes each situation:</h4>
                    
                    <div class="dialogue-container">
                        <p><strong>1. Situation:</strong> Tom forgot his girlfriend's birthday and didn't buy a gift. When she found out, she was furious and wouldn't speak to him for days.</p>
                        <p><strong>Which idiom best describes Tom's situation?</strong></p>
                        <div class="options">
                            <div class="option" onclick="selectOption(this, 'task7', 1)">
                                <input type="radio" name="situation1" value="a"> a) Water under the bridge
                            </div>
                            <div class="option" onclick="selectOption(this, 'task7', 1)">
                                <input type="radio" name="situation1" value="b"> b) In hot water
                            </div>
                            <div class="option" onclick="selectOption(this, 'task7', 1)">
                                <input type="radio" name="situation1" value="c"> c) No harm done
                            </div>
                        </div>
                    </div>
                    
                    <div class="dialogue-container">
                        <p><strong>2. Situation:</strong> Mike was supposed to submit his assignment last Friday but handed it in on Monday instead. His teacher accepted it and said, "It's good you finished it."</p>
                        <p><strong>Which idiom best applies to this situation?</strong></p>
                        <div class="options">
                            <div class="option" onclick="selectOption(this, 'task7', 2)">
                                <input type="radio" name="situation2" value="a"> a) Water under the bridge
                            </div>
                            <div class="option" onclick="selectOption(this, 'task7', 2)">
                                <input type="radio" name="situation2" value="b"> b) Better late than never
                            </div>
                            <div class="option" onclick="selectOption(this, 'task7', 2)">
                                <input type="radio" name="situation2" value="c"> c) In hot water
                            </div>
                        </div>
                    </div>
                </div>

                <div class="question">
                    <h4>B. Complete these explanations using the most appropriate idiom:</h4>
                    
                    <p><strong>1. Situation:</strong> You accidentally deleted your friend's important files from their computer.</p>
                    <p>"I'm so sorry! I know I'm 
                        <select id="complete1" class="dialogue-select">
                            <option value="">Choose idiom...</option>
                            <option value="no-harm-done">no harm done</option>
                            <option value="in-hot-water">in hot water</option>
                            <option value="better-late">better late than never</option>
                        </select>
                        now, but I promise I'll help you recover everything."
                    </p>
                                        
                    <p><strong>2. Situation:</strong> You missed your flight but managed to catch the next one and still arrived for your friend's party.</p>
                    <p>"I missed my original flight, but 
                        <select id="complete2" class="dialogue-select">
                            <option value="">Choose idiom...</option>
                            <option value="in-hot-water">in hot water</option>
                            <option value="better-late">better late than never</option>
                            <option value="no-harm-done">no harm done</option>
                        </select>
                        – I'm glad I didn't miss the whole party!"
                    </p>
                    
                    <p><strong>3. Situation:</strong> You and your friend had an argument last month, but now you've both forgiven each other and moved on.</p>
                    <p>"That argument we had is 
                        <select id="complete3" class="dialogue-select">
                            <option value="">Choose idiom...</option>
                            <option value="in-hot-water">in hot water</option>
                            <option value="water-bridge">water under the bridge</option>
                            <option value="no-harm-done">no harm done</option>
                        </select>
                        now. Let's not worry about it anymore."
                    </p>
                </div>

                <div class="task-controls">
                    <button class="check-btn" onclick="checkTask7()">Check Answers</button>
                    <button class="reset-btn" onclick="resetTask7()">Reset</button>
                </div>

                <div class="feedback" id="task7-feedback"></div>
            </div>
        </main>
    </div>

    <script>
        // Application state
        let currentTaskNumber = 1;
        const totalTasks = 7; // Updated total tasks
        let completedTasks = new Set();
        let taskAnswers = {};
        let glossaryTooltip = null;

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            loadProgress();
            updateTaskNumbers();
            updateProgress();
            updateNavigation();
            initializeGlossary();
            showTask(currentTaskNumber);
        });

        // Task navigation
        function showTask(taskNum) {
            document.querySelectorAll('.task').forEach(task => task.classList.remove('active'));
            document.getElementById(`task${taskNum}`).classList.add('active');
            currentTaskNumber = taskNum;
            document.getElementById('currentTask').textContent = taskNum;
            updateTaskNumbers();
            updateNavigation();
            hideAllFeedback();
            saveProgress();
        }

        function nextTask() {
            if (currentTaskNumber < totalTasks) showTask(currentTaskNumber + 1);
        }

        function previousTask() {
            if (currentTaskNumber > 1) showTask(currentTaskNumber - 1);
        }

        function updateNavigation() {
            document.getElementById('prevBtn').disabled = currentTaskNumber === 1;
            document.getElementById('nextBtn').disabled = currentTaskNumber === totalTasks;
        }

        function updateTaskNumbers() {
            const container = document.getElementById('taskNumbers');
            container.innerHTML = '';
            for (let i = 1; i <= totalTasks; i++) {
                const btn = document.createElement('button');
                btn.className = 'task-num';
                btn.textContent = i;
                btn.onclick = () => showTask(i);
                if (i === currentTaskNumber) btn.classList.add('active');
                if (completedTasks.has(i)) btn.classList.add('completed');
                container.appendChild(btn);
            }
        }

        function updateProgress() {
            const progress = (completedTasks.size / totalTasks) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
        }

        // Progress saving and loading
        function saveProgress() {
            const progress = {
                currentTask: currentTaskNumber,
                completedTasks: Array.from(completedTasks),
            };
            localStorage.setItem('explanationsGuideProgress', JSON.stringify(progress));
        }

        function loadProgress() {
            const saved = localStorage.getItem('explanationsGuideProgress');
            if (saved) {
                const progress = JSON.parse(saved);
                currentTaskNumber = progress.currentTask || 1;
                completedTasks = new Set(progress.completedTasks || []);
            }
        }

        // Generic Option selection
        function selectOption(element, taskId, questionNum) {
            element.parentNode.querySelectorAll('.option').forEach(opt => opt.classList.remove('selected'));
            element.classList.add('selected');
            const radio = element.querySelector('input[type="radio"]');
            if (radio) radio.checked = true;
        }

        // Feedback functions
        function showFeedback(taskId, isSuccess, message) {
            const feedback = document.getElementById(`${taskId}-feedback`);
            feedback.className = `feedback ${isSuccess ? 'success' : 'error'} show`;
            feedback.innerHTML = message;
        }

        function hideAllFeedback() {
            document.querySelectorAll('.feedback').forEach(feedback => feedback.classList.remove('show'));
        }

        // Glossary functionality
        function initializeGlossary() {
            document.body.addEventListener('click', function(e) {
                if (e.target.classList.contains('glossary-term')) {
                    createOrUpdateTooltip(e.target);
                } else if (glossaryTooltip) {
                    glossaryTooltip.remove();
                    glossaryTooltip = null;
                }
            });
        }

        function createOrUpdateTooltip(termElement) {
            if (glossaryTooltip) {
                glossaryTooltip.remove();
                glossaryTooltip = null;
            }
            glossaryTooltip = document.createElement('div');
            glossaryTooltip.className = 'glossary-tooltip';
            glossaryTooltip.textContent = termElement.dataset.translation;
            termElement.appendChild(glossaryTooltip);
        }

        // Task 1: Language Discovery
        let task1Answers = { explanation: [], regret: [], problem: [], idiom: [] };
        let selectedPhrase = null;

        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.clickable-phrase').forEach(phrase => {
                phrase.addEventListener('click', function(e) {
                    e.stopPropagation(); // Prevent body click from closing tooltip immediately
                    if (!this.classList.contains('found')) {
                        document.querySelectorAll('.clickable-phrase').forEach(p => p.classList.remove('selected'));
                        this.classList.add('selected');
                        selectedPhrase = {
                            element: this,
                            text: this.dataset.phrase,
                            correctCategory: this.dataset.category
                        };
                        document.getElementById('selected-phrase').innerHTML = `Selected: "${this.dataset.phrase}"`;
                        document.querySelectorAll('.category-btn').forEach(btn => btn.disabled = false);
                    }
                });
            });
            
            document.querySelectorAll('.category-btn').forEach(button => {
                button.addEventListener('click', function(e) {
                    e.stopPropagation();
                    if (selectedPhrase) {
                        const selectedCategory = this.dataset.category;
                        selectedPhrase.element.classList.add('found');
                        selectedPhrase.element.classList.remove('selected');
                        if (!task1Answers[selectedCategory].includes(selectedPhrase.text)) {
                            task1Answers[selectedCategory].push(selectedPhrase.text);
                        }
                        updateTask1Display(selectedCategory, selectedPhrase.text);
                        selectedPhrase = null;
                        document.getElementById('selected-phrase').innerHTML = '<em>Select a phrase from the text above...</em>';
                        document.querySelectorAll('.category-btn').forEach(btn => btn.disabled = true);
                    }
                });
                button.disabled = true;
            });
        });

        function updateTask1Display(category, phrase) {
            const container = document.getElementById(`${category}-phrases`);
            if (container.querySelector('em')) container.innerHTML = '';
            const span = document.createElement('span');
            span.className = 'found-phrase';
            span.textContent = phrase;
            container.appendChild(span);
        }

        function checkTask1() {
            const expectedAnswers = {
                explanation: ["The thing is", "What happened was", "You see", "Due to", "The problem was"],
                regret: ["I feel terrible about", "I'm so embarrassed", "I hate to say this", "I feel so bad about"],
                problem: ["disasters", "crashed", "glitch", "delayed", "failure"],
                idiom: ["like an ice rink", "Better late than never", "no harm done"]
            };

            let correctCount = 0;
            let totalExpected = 0;
            
            Object.keys(expectedAnswers).forEach(category => {
                totalExpected += expectedAnswers[category].length;
                expectedAnswers[category].forEach(phrase => {
                    if (task1Answers[category] && task1Answers[category].includes(phrase)) {
                        correctCount++;
                    }
                });
            });

            const percentage = Math.round((correctCount / totalExpected) * 100);
            
            if (percentage >= 80) {
                completedTasks.add(1);
                showFeedback('task1', true, `🎉 Excellent work! You correctly categorized ${correctCount} of ${totalExpected} phrases (${percentage}%).`);
            } else {
                showFeedback('task1', false, `You found ${correctCount} of ${totalExpected} phrases (${percentage}%). <div class="explanation">Try to find more phrases for each category. Reset and try again!</div>`);
            }
            updateProgress();
            updateTaskNumbers();
            saveProgress();
        }

        function resetTask1() {
            task1Answers = { explanation: [], regret: [], problem: [], idiom: [] };
            selectedPhrase = null;
            document.querySelectorAll('.clickable-phrase').forEach(p => p.classList.remove('found', 'selected'));
            document.getElementById('selected-phrase').innerHTML = '<em>Select a phrase from the text above...</em>';
            document.querySelectorAll('.category-btn').forEach(btn => btn.disabled = true);
            document.querySelectorAll('.phrase-list').forEach(c => c.innerHTML = '<em>Click phrases, then category buttons...</em>');
            hideAllFeedback();
        }

        // Task 2: True/False
        function checkTask2() {
            const correctAnswers = [false, true, false, false, false, true];
            const explanations = [
                "1. False - Her phone died overnight; she didn't forget to set the alarm.",
                "2. True - The text says she was running fast and didn't notice the water.",
                "3. False - It crashed 'just as she was finishing it', so it was almost done.",
                "4. False - It was due to signal problems, which were beyond her control.",
                "5. False - Her parents were understanding and saved her food.",
                "6. True - She spoke formally to her manager and boss, but casually to her colleague and family."
            ];

            let correctCount = 0;
            let feedbackText = '<h4>Results:</h4>';
            
            for (let i = 1; i <= 6; i++) {
                const selectedOption = document.querySelector(`input[name="q${i}"]:checked`);
                const isCorrect = selectedOption && (selectedOption.parentNode.textContent.trim() === 'True') === correctAnswers[i-1];
                if (isCorrect) correctCount++;
                feedbackText += `<p><strong>Question ${i}:</strong> ${isCorrect ? '✅ Correct.' : '❌ Incorrect.'} ${explanations[i-1]}</p>`;
            }

            if (correctCount >= 5) {
                completedTasks.add(2);
                showFeedback('task2', true, `🎉 Great job! You got ${correctCount}/6 correct. ${feedbackText}`);
            } else {
                showFeedback('task2', false, `You got ${correctCount}/6 correct. ${feedbackText}<div class="explanation">Read the questions and the story again carefully.</div>`);
            }
            updateProgress();
            updateTaskNumbers();
            saveProgress();
        }

        function resetTask2() {
            document.querySelectorAll('#task2 input[type="radio"]').forEach(radio => radio.checked = false);
            document.querySelectorAll('#task2 .option').forEach(option => option.classList.remove('selected'));
            hideAllFeedback();
        }

        // Task 3: Pattern Analysis
        function checkTask3() {
            const patternAnswers = { pattern1: 'to', pattern2: 'see', pattern3: 'happened', pattern4: 'problem', pattern5: 'reason' };
            let correctCount = 0;
            let totalQuestions = 5;
            let feedbackText = '<h4>Results:</h4>';

            Object.keys(patternAnswers).forEach(id => {
                const userAnswer = document.getElementById(id).value.toLowerCase().trim();
                const isCorrect = userAnswer === patternAnswers[id];
                if (isCorrect) correctCount++;
                feedbackText += `<p><strong>Pattern ${id.slice(-1)}:</strong> ${isCorrect ? '✅ Correct!' : `❌ Incorrect. The answer is "${patternAnswers[id]}".`}</p>`;
            });

            if (correctCount >= 4) {
                completedTasks.add(3);
                showFeedback('task3', true, `🎉 Excellent! You got ${correctCount}/${totalQuestions} correct. ${feedbackText}`);
            } else {
                showFeedback('task3', false, `You got ${correctCount}/${totalQuestions} correct. ${feedbackText}`);
            }
            updateProgress();
            updateTaskNumbers();
            saveProgress();
        }

        function resetTask3() {
            ['pattern1', 'pattern2', 'pattern3', 'pattern4', 'pattern5'].forEach(id => document.getElementById(id).value = '');
            hideAllFeedback();
        }

        // Task 4: Grammar Focus
        function checkTask4() {
            const answers = {
                grammar1: 'noun phrase', grammar2: 'noun phrase', grammar3: 'noun phrase', grammar4: 'subject + verb',
                rewrite1: 'the rain', rewrite2: 'the computer crash', rewrite3: 'the train delay', rewrite4: 'since her phone was dead'
            };
            let correctCount = 0;
            let totalQuestions = 8;
            let feedbackText = '<h4>Results:</h4>';

            Object.keys(answers).forEach(id => {
                const userAnswer = document.getElementById(id).value.toLowerCase().trim().replace('.', '');
                const isCorrect = userAnswer === answers[id];
                if (isCorrect) correctCount++;
                const feedbackType = id.startsWith('grammar') ? 'Rule' : 'Rewrite';
                feedbackText += `<p><strong>${feedbackType} ${id.slice(-1)}:</strong> ${isCorrect ? '✅ Correct!' : `❌ Incorrect. Expected: "${answers[id]}".`}</p>`;
            });

            if (correctCount >= 6) {
                completedTasks.add(4);
                showFeedback('task4', true, `🎉 Well done! You got ${correctCount}/${totalQuestions} correct. ${feedbackText}`);
            } else {
                showFeedback('task4', false, `You got ${correctCount}/${totalQuestions} correct. ${feedbackText}<div class="explanation">Remember: "Because of/Due to/As a result of" + Noun. "Since" + Subject + Verb.</div>`);
            }
            updateProgress();
            updateTaskNumbers();
            saveProgress();
        }

        function resetTask4() {
            ['grammar1', 'grammar2', 'grammar3', 'grammar4', 'rewrite1', 'rewrite2', 'rewrite3', 'rewrite4'].forEach(id => document.getElementById(id).value = '');
            hideAllFeedback();
        }

        // Task 5: Expression Practice (formerly Task 6)
        function checkTask5() {
            const dialogueAnswers = { dialogue1: 'what-happened', dialogue2a: 'feel-terrible', dialogue2b: 'you-see', dialogue3: 'embarrassed' };
            let correctCount = 0;
            let totalQuestions = 4;
            let feedbackText = '<h4>Part A Results:</h4>';

            Object.keys(dialogueAnswers).forEach(id => {
                const isCorrect = document.getElementById(id).value === dialogueAnswers[id];
                if (isCorrect) correctCount++;
                feedbackText += `<p><strong>Dialogue ${id.match(/\d+/)[0]}:</strong> ${isCorrect ? '✅ Correct!' : '❌ Incorrect. Try another option.'}</p>`;
            });

            if (correctCount >= 3) {
                completedTasks.add(5);
                showFeedback('task5', true, `🎉 Excellent work! You got ${correctCount}/${totalQuestions} correct. ${feedbackText}<div class="explanation">Now, make sure to practice Part B by speaking out loud!</div>`);
            } else {
                showFeedback('task5', false, `You got ${correctCount}/${totalQuestions} correct. ${feedbackText}<div class="explanation">Review the expressions from Task 1 and try again.</div>`);
            }
            updateProgress();
            updateTaskNumbers();
            saveProgress();
        }

        function resetTask5() {
            ['dialogue1', 'dialogue2a', 'dialogue2b', 'dialogue3'].forEach(id => document.getElementById(id).value = '');
            hideAllFeedback();
        }

        // Task 6: Idiom Exploration (formerly Task 7)
        function checkTask6() {
            const idiomAnswers = { idiom1: 'b', idiom2: 'a', idiom3: 'c', idiom4: 'd' };
            const contextAnswers = { context1: 'in-hot-water', context2: 'no-harm-done', context3: 'water-bridge' };
            let correctCount = 0;
            let totalQuestions = 7;
            let feedbackText = '<h4>Results:</h4>';

            Object.keys(idiomAnswers).forEach(id => {
                const isCorrect = document.getElementById(id).value === idiomAnswers[id];
                if (isCorrect) correctCount++;
                feedbackText += `<p><strong>Matching ${id.slice(-1)}:</strong> ${isCorrect ? '✅ Correct!' : '❌ Incorrect.'}</p>`;
            });

            Object.keys(contextAnswers).forEach(id => {
                const isCorrect = document.getElementById(id).value === contextAnswers[id];
                if (isCorrect) correctCount++;
                feedbackText += `<p><strong>Sentence ${id.slice(-1)}:</strong> ${isCorrect ? '✅ Correct!' : '❌ Incorrect.'}</p>`;
            });

            if (correctCount >= 6) {
                completedTasks.add(6);
                showFeedback('task6', true, `🎉 Outstanding! You got ${correctCount}/${totalQuestions} correct. ${feedbackText}`);
            } else {
                showFeedback('task6', false, `You got ${correctCount}/${totalQuestions} correct. ${feedbackText}`);
            }
            updateProgress();
            updateTaskNumbers();
            saveProgress();
        }

        function resetTask6() {
            ['idiom1', 'idiom2', 'idiom3', 'idiom4', 'context1', 'context2', 'context3'].forEach(id => document.getElementById(id).value = '');
            hideAllFeedback();
        }
        
        // Task 7: Idiom Application (formerly Task 8)
        function checkTask7() {
            const situationAnswers = ['b', 'b'];
            const completionAnswers = { complete1: 'in-hot-water', complete2: 'better-late', complete3: 'water-bridge' };
            let correctCount = 0;
            let totalQuestions = 5;
            let feedbackText = '<h4>Results:</h4>';

            for (let i = 1; i <= 2; i++) {
                const selectedOption = document.querySelector(`input[name="situation${i}"]:checked`);
                const isCorrect = selectedOption && selectedOption.value === situationAnswers[i-1];
                if (isCorrect) correctCount++;
                feedbackText += `<p><strong>Situation ${i}:</strong> ${isCorrect ? '✅ Correct!' : '❌ Incorrect.'}</p>`;
            }

            Object.keys(completionAnswers).forEach(id => {
                const isCorrect = document.getElementById(id).value === completionAnswers[id];
                if (isCorrect) correctCount++;
                feedbackText += `<p><strong>Completion ${id.slice(-1)}:</strong> ${isCorrect ? '✅ Correct!' : '❌ Incorrect.'}</p>`;
            });

            if (correctCount >= 4) {
                completedTasks.add(7);
                showFeedback('task7', true, `🎉 Fantastic! You got ${correctCount}/${totalQuestions} correct. You've mastered idiom usage! ${feedbackText}
                <div class="explanation"><strong>🎓 Congratulations! You've completed all tasks!</strong></div>`);
            } else {
                showFeedback('task7', false, `You got ${correctCount}/${totalQuestions} correct. ${feedbackText}<div class="explanation">Review the idiom meanings and try again.</div>`);
            }
            updateProgress();
            updateTaskNumbers();
            saveProgress();
        }

        function resetTask7() {
            ['situation1', 'situation2'].forEach(name => document.querySelectorAll(`input[name="${name}"]`).forEach(r => r.checked = false));
            ['complete1', 'complete2', 'complete3'].forEach(id => document.getElementById(id).value = '');
            document.querySelectorAll('#task7 .option').forEach(option => option.classList.remove('selected'));
            hideAllFeedback();
        }
    </script>
</body>
</html>
